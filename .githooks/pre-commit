#!/usr/bin/env bash
set -euo pipefail

branch="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
[[ "$branch" == "main" ]] || exit 0

version_file="app_version.js"

today="$(date -u +%F)"
tomorrow="$(python3 - <<'PY'
from datetime import datetime, timedelta, timezone
now = datetime.now(timezone.utc)
print((now.date() + timedelta(days=1)).isoformat())
PY
)"

since="${today}T00:00:00Z"
until="${tomorrow}T00:00:00Z"

count="$(git rev-list --count --since="$since" --until="$until" main 2>/dev/null || echo 0)"
x="$((count + 1))"
version="${today}_${x}"

content=$(cat <<EOF
// generated; do not edit
window.APP_VERSION = "${version}";
EOF
)

current=""
[[ -f "$version_file" ]] && current="$(cat "$version_file" || true)"

if [[ "$current" != "$content" ]]; then
  printf "%s\n" "$content" > "$version_file"
  git add -- "$version_file"
fi
