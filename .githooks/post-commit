#!/usr/bin/env bash
set -euo pipefail

branch="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
[[ "$branch" == "main" ]] || exit 0

version_file="app_version.js"
[[ -f "$version_file" ]] || exit 0

version="$(sed -n 's/.*APP_VERSION = "\([^"]*\)".*/\1/p' "$version_file" | head -n 1)"
[[ -n "$version" ]] || exit 0

tag="v${version}"

if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
  exit 0
fi

git tag "$tag"
