#!/usr/bin/env bash
set -euo pipefail

branch="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
if [[ "$branch" != "main" ]]; then
  exit 0
fi

version_file="app_version.txt"
if [[ ! -f "$version_file" ]]; then
  exit 0
fi

version="$(tr -d '[:space:]' < "$version_file")"
tag="v${version}"

# If tag already exists, don't clobber it.
if git rev-parse -q --verify "refs/tags/$tag" >/dev/null; then
  echo "post-commit: tag already exists: $tag (not retagging)" >&2
  exit 0
fi

git tag "$tag"
exit 0
